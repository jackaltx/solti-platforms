---
name: CI

on:
  push:
    branches: [main]
    paths:
      - 'roles/**'
      - 'playbooks/**'
      - '.github/**'
  pull_request:
    branches: [main]
    paths:
      - 'roles/**'
      - 'playbooks/**'
  workflow_dispatch:

env:
  PY_COLORS: 1
  ANSIBLE_FORCE_COLOR: 1

jobs:
  validate:
    name: Validate Collection
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            ansible-core==2.18.1 \
            ansible-lint==24.12.1 \
            yamllint==1.35.1

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install community.general
          ansible-galaxy collection install -r requirements.yml || echo "No requirements.yml found"

      - name: Validate role structure
        run: |
          for role in roles/*/; do
            role_name=$(basename "$role")
            echo "Validating role: $role_name"

            # Check required directories exist
            for dir in tasks defaults vars; do
              if [ ! -d "$role/$dir" ]; then
                echo "ERROR: Role $role_name missing $dir directory"
                exit 1
              fi
            done

            # Check main.yml exists
            if [ ! -f "$role/tasks/main.yml" ]; then
              echo "ERROR: Role $role_name missing tasks/main.yml"
              exit 1
            fi

            echo "✓ Role $role_name structure valid"
          done

      - name: Test collection build
        run: |
          ansible-galaxy collection build
          echo "✓ Collection builds successfully"

      - name: Upload collection artifact
        uses: actions/upload-artifact@v4
        with:
          name: collection-build
          path: "*.tar.gz"
          retention-days: 5
          if-no-files-found: error

  # Note: Actual VM creation tests cannot run in GitHub CI
  # These require Proxmox infrastructure
  # Use manage-platform.sh locally for integration testing
