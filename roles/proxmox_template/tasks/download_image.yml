---
# Download cloud image from distribution URL
# Validates against remote checksum before downloading

- name: Check for image updates
  ansible.builtin.include_tasks: check_for_update.yml

- name: Skip download if image is current
  ansible.builtin.debug:
    msg: "Using cached image (checksum matches remote)"
  when:
    - not image_needs_update
    - local_image.stat.exists

- name: Display force download notice
  ansible.builtin.debug:
    msg: "Force download enabled - re-downloading even though checksums match"
  when:
    - not image_needs_update
    - template_force_download | default(false)

- name: Display update notice
  ansible.builtin.debug:
    msg: "Update available - downloading new image version"
  when: image_needs_update

- name: Download {{ template_distribution }} cloud image
  ansible.builtin.get_url:
    url: "{{ template_image_url }}"
    dest: "{{ template_work_dir }}/{{ template_image_file }}"
    mode: "0644"
  become: true
  when: image_needs_update or (template_force_download | default(false))
  register: download_result

- name: Display download status
  ansible.builtin.debug:
    msg: "Image downloaded: {{ template_image_file }}"
  when: download_result is changed
