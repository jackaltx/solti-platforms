---
#
# proxmox_template role - supports present and absent states
# States:
#   present: Build Proxmox VM template from cloud image
#   absent: Remove template (optionally remove downloaded images)
#

- name: Validate state parameter
  ansible.builtin.fail:
    msg: "template_state must be one of: present, absent. Current value: {{ template_state }}"
  when: template_state not in ['present', 'absent']

- name: Include distribution-specific variables
  ansible.builtin.include_vars: "{{ template_distribution }}.yml"

# =======================================================================
# BUILD TEMPLATE
# =======================================================================

- name: Build Proxmox template
  when: template_state == 'present'
  block:
    - name: Create work directory
      ansible.builtin.file:
        path: "{{ template_work_dir }}"
        state: directory
        mode: "0755"
      become: true

    # -------------
    # Calculate next available VMID using smart numbering
    # Rocky 9: 7001-7999, Rocky 10: 10001-10999, Debian 12: 8001-8999
    - name: Calculate next VMID
      ansible.builtin.include_tasks: calculate_vmid.yml

    # Download and prepare the cloud-init enabled image
    - name: Download cloud image
      ansible.builtin.include_tasks: download_image.yml

    - name: Resize disk image
      ansible.builtin.include_tasks: resize_image.yml

    # -------------
    # NOT SURE WHY, but createing the I can't see not this group of tasks separately?

    # in this case I want to create a vm, is cloud-init enabled?  is it to be a template?
    - name: Create VM
      ansible.builtin.include_tasks: create_vm.yml

    - name: Import disk
      ansible.builtin.include_tasks: import_disk.yml

    - name: Configure storage
      ansible.builtin.include_tasks: configure_storage.yml

    # if this is cloud-init image, so why would we not do this?
    - name: Setup cloud-init
      ansible.builtin.include_tasks: setup_cloudinit.yml
    # -------------

    # This I can see not doing (if I wanted a non-template)
    - name: Convert to template
      ansible.builtin.include_tasks: convert_template.yml

    # Set template notes with build metadata
    - name: Set template notes
      ansible.builtin.include_tasks: set_notes.yml

    # If desired
    - name: Cleanup downloaded images
      ansible.builtin.include_tasks: cleanup.yml
      when: template_cleanup | default(true)

    # for templates and non-templates.
    - name: Verify template
      ansible.builtin.include_tasks: verify.yml

# =======================================================================
# REMOVE TEMPLATE
# =======================================================================

- name: Remove Proxmox template
  when: template_state == 'absent'
  block:
    # which one to destroy?
    - name: Destroy template VM
      ansible.builtin.command: "qm destroy {{ template_vmid }}"
      become: true
      ignore_errors: true
      register: destroy_result

    - name: Display removal result
      ansible.builtin.debug:
        msg: "Template {{ template_vmid }} ({{ template_name }}) {{ 'removed' if destroy_result.rc == 0 else 'not found or already removed' }}"

    # interesting, a coupled effect (delete image and vm? dunno)
    - name: Remove downloaded images
      ansible.builtin.file:
        path: "{{ template_work_dir }}/{{ template_image_file }}"
        state: absent
      when: template_cleanup | default(false)
